apply scroll_vbar
    color green
    hfill 1.0
    vfill 1.0
    span 1

    script
        var body_outer self.parent.children.scroll_body.0;
        var body_inner body_outer.children.body.0;

        println "body_outer {body_outer}"

    node
        text -
        color blue
    node
        vfill 1.0
        vexpand 1.0

        node
            text =
            color red

            draggable
            #pressable

            #valign 0

            script
                var track self.parent;
                var start;

                set self.valign.p 0.0;
                println body_outer.computed.size
                #set self.height.p 0.0
                #println "fill is {}, outer={}, inner={}" self.vfill.s body_outer.computed.size.y body_inner.computed.size.y
                fn on_layout_change() {
                    set self.vfill.s (min (/ body_outer.computed.size.y body_inner.computed.size.y) 1.0)
                }
                body_outer.add_event_listener "layout_changed" on_layout_change
                body_inner.add_event_listener "layout_changed" on_layout_change


                self.add_event_listener "drag_begin" [fn (d) {
                    set self.valign.p self.computed.cell.top
                    set start self.computed.cell.top
                    set self.vfill.s (min (/ body_outer.computed.size.y body_inner.computed.size.y) 1.0)
                }]

                self.add_event_listener "drag_end" [fn () {
                    set self.valign.s (clamp (/ self.computed.cell.top self.computed.cell.sum.y) 0.0 1.0)
                }]

                self.add_event_listener "drag_y" [fn (d) {
                    set self.valign.p (+ start d.dist)
                    #set body_outer.vscroll.p self.valign.p
                    #println self.valign.p
                    set body_outer.vscroll.s (/ self.valign.p self.computed.cell.sum.y)
                }]
    node
        text +
        color blue

apply scroll_body
    text xx
    color 50 50 50
    hfill 1.0
    vfill 1.0
    hexpand 1.0
	width 0
	height 0

apply scroll_template
    node scroll_body
        node body
            halign left
            valign top
    node scroll_vbar




stub body_test_element
	script

	node
		width 150
		height 150
		color blue

template body_test
    gap 10
    color grey

    script
        var w 5, h 5;
        set self.span w;
        for i 0 (* w h) {
            var e (call stub_body_test_element self)
            #println e #.0.color.r
            #set e.0.color.r 1.0

            var s (abs (cos (float i)))
            var t (abs (sin (float i)))

            set e.0.color.r (* 0.8 s)
            set e.0.color.g (* 0.8 s s)
            set e.0.color.b (* 0.8 (- 1.0 t))

            set e.0.text i
        }



node scroll_template
    width 0.8
    height 0.8

    apply body
        template body_test

node fps
    floating
    halign right
    valign top
    color 0.0 0.0 0.0 0.5
    font_size 16
    script
        root.add_event_listener "fps" [fn (fps) {set self.text fps;}]